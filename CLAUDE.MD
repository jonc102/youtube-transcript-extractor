# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Distill is a Chrome Manifest V3 extension that extracts transcripts from YouTube videos and optionally processes them using OpenAI or Claude AI with custom prompts.

**Current Version:** 4.1.0
**Branch Strategy:** `main` is the stable branch (contains v4.1.0). All PRs should target `main`. Create feature branches from `main`.

## Development Workflow

### Zero-Build Architecture

This extension has **no build process**:
- No `package.json`, no npm dependencies, no bundler
- All JavaScript is vanilla ES6
- Direct file editing workflow
- No transpilation or compilation

### Loading the Extension

1. Navigate to `chrome://extensions/`
2. Enable "Developer mode" (top-right toggle)
3. Click "Load unpacked"
4. Select the repository folder
5. Extension loads immediately

### Reloading During Development

After editing any files:
1. Go to `chrome://extensions/`
2. Click the reload icon on the extension card
3. If you modified `content.js`, also refresh the YouTube page

### Debugging

**Popup (popup.js):**
- Right-click extension icon → "Inspect popup"
- Opens dedicated DevTools instance for popup

**Settings Page (settings.js):**
- Right-click on settings page → "Inspect"
- Check Network tab for API calls
- Check Application → Storage → Chrome Sync for saved settings

**Content Script (content.js):**
- Open YouTube page
- Press F12 to open DevTools
- Check Console tab for content script logs

**Background Service Worker (background.js):**
- Go to `chrome://extensions/`
- Click "service worker" link under the extension
- Opens dedicated DevTools instance for background worker

### Icon Generation (Optional)

If modifying icons:
```bash
python3 create_icons.py
```
Generates icon16.png, icon48.png, icon128.png from RGB data.

## Architecture Overview

### Component Structure

```
manifest.json                    # Extension configuration (permissions, content scripts, background worker)
├── popup.html/css/js            # Extension popup UI (extract button)
├── settings.html/css/js         # Settings page (API keys, prompts, models)
├── background.js                # Service worker (CORS bypass, API calls, streaming ports, chat handlers)
└── Content Scripts (run on YouTube pages):
    ├── constants.js             # Shared constants (timing, selectors, limits) — loaded first
    ├── utils.js                 # Shared utility functions (logging, HTML escaping, markdown)
    ├── theme-detector.js        # Detects YouTube light/dark theme
    ├── cache-manager.js         # Local cache with LRU eviction (10 videos)
    ├── chat-manager.js          # Manages per-video chat conversation state
    ├── modal-ui.js              # Modal creation, display, interactions, chat UI, streaming display
    ├── modal-styles.css         # Modal styling with theme support, chat styles, minimize styles
    ├── transcript-orchestrator.js  # Unified extraction/caching/streaming/chat flow
    ├── content.js               # YouTube transcript extraction with MutationObserver
    └── content-injector.js      # Floating purple FAB entry point
```

### Message Passing Architecture

The extension uses three message channels:

**Channel 1: Popup ↔ Content Script**
```javascript
// popup.js sends to content.js
chrome.tabs.sendMessage(tabId, { action: 'getTranscript' });

// content.js responds
chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
  if (request.action === 'getTranscript') {
    getTranscript().then(result => sendResponse(result));
    return true; // CRITICAL: Keep channel open for async response
  }
});
```

Response format: `{ success: true, transcript: "...", videoId: "..." }`

**Channel 2: Popup/Settings ↔ Background Worker**
```javascript
// api.js or settings.js sends to background.js
chrome.runtime.sendMessage({
  action: 'callOpenAI',  // or 'callClaude', 'fetchOpenAIModels', 'fetchClaudeModels'
  apiKey, model, prompt, transcript
});

// background.js responds
chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
  if (request.action === 'callOpenAI') {
    callOpenAI(...).then(result => sendResponse({ success: true, result }));
    return true; // CRITICAL: Keep channel open for async response
  }
});
```

**Channel 3: Background Worker ↔ External APIs**
```javascript
// background.js makes direct fetch() calls
fetch('https://api.openai.com/v1/chat/completions', {
  method: 'POST',
  headers: { 'Authorization': `Bearer ${apiKey}` }
});
```

**Channel 4: Streaming via Ports (Content Script ↔ Background Worker)**
```javascript
// transcript-orchestrator.js connects to background.js for streaming
const port = chrome.runtime.connect({ name: 'streamOpenAI' }); // or 'streamClaude'
port.postMessage({ apiKey, model, prompt, transcript });
port.onMessage.addListener((msg) => {
  if (msg.type === 'chunk') { /* progressive text */ }
  if (msg.type === 'done') { /* stream complete */ }
  if (msg.type === 'error') { /* handle error */ }
});
```

**Channel 5: Chat Messages (Content Script ↔ Background Worker)**
```javascript
// Multi-turn chat via one-shot messages
chrome.runtime.sendMessage({
  action: 'chatOpenAI',  // or 'chatClaude'
  apiKey, model, messages: [{role, content}, ...], system
});
```

**Why background.js exists:** Content scripts and popup/settings pages cannot make cross-origin API requests due to CORS. The background service worker bypasses this restriction.

### Critical Pattern: Async Message Responses

ALL message listeners that respond asynchronously **must** return `true`:

```javascript
chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
  asyncFunction()
    .then(result => sendResponse(result))
    .catch(error => sendResponse({ error }));
  return true; // Without this, Chrome closes the channel before async response
});
```

## Key Components

### background.js (Service Worker)

Acts as a CORS bypass proxy for API calls. Implements:

- `formatModelLabel(modelId)` - Converts raw model IDs to user-friendly labels (e.g., "gpt-4o" → "GPT-4o")
- `fetchOpenAIModels(apiKey)` - Fetches models from OpenAI `/v1/models` endpoint
  - Filters by excluding non-chat models (embedding, whisper, tts, dall-e, legacy models)
  - Includes all GPT, O1, and ChatGPT variants
  - Returns models with friendly labels and priority sorting
  - Logs discovered models to console for debugging
- `fetchClaudeModels(apiKey)` - Validates Claude API key with test request, returns hardcoded model list
- `callOpenAI(apiKey, model, prompt, transcript)` - Calls OpenAI chat completions with dynamic parameters
  - Uses `max_completion_tokens` for O1/GPT-4o models, `max_tokens` for legacy models
  - Includes `temperature: 0.7` for non-O1 models, excludes it for O1 models
  - Backward compatible with GPT-3.5/GPT-4, forward compatible with O1/GPT-4o
- `callClaude(apiKey, model, prompt, transcript)` - Calls Claude messages API (max_tokens 4096)
- `chatOpenAI(apiKey, model, messages)` - Multi-turn chat via OpenAI (v4.0)
- `chatClaude(apiKey, model, messages, system)` - Multi-turn chat via Claude with top-level system param (v4.0)
- `fetchWithRetry(url, options, maxRetries, retryDelays)` - Retry wrapper for transient errors (429, 500, 502, 503)
- `_buildOpenAIHeaders(apiKey)` / `_buildClaudeHeaders(apiKey)` - Shared header builders
- `_buildOpenAIRequestBody(model, messages, options)` - Model-specific request body builder (GPT-5-nano: 16384 tokens for reasoning headroom, others: 4000)
- Port handlers: `streamOpenAI` / `streamClaude` - SSE streaming via `chrome.runtime.connect()` ports

All functions use `fetch()` with proper authentication headers. Streaming uses `response.body.getReader()` for SSE parsing.

### content.js (YouTube Transcript Extraction)

Extracts transcripts from YouTube's DOM:

1. Checks if transcript panel is open
2. If not, clicks "More actions" button → "Show transcript" menu item
3. Uses MutationObserver (`waitForElement()`) to detect DOM changes, with fixed-delay fallbacks
4. Queries transcript segments via `YTE_CONSTANTS.SELECTORS.TRANSCRIPT_SEGMENTS`
5. Extracts timestamp and text from each segment using constant selector arrays
6. Formats as `[timestamp] text` per line

**Multiple selector fallbacks** for YouTube UI resilience:
```javascript
const timestampElement = segment.querySelector('.segment-timestamp') ||
                        segment.querySelector('[class*="segment-timestamp"]') ||
                        segment.querySelector('div[class*="cue-group"] div[class*="cue"]:first-child');
```

### popup.js (Main UI Logic)

Flow:
1. Validates user is on YouTube `/watch?v=` page
2. Injects `content.js` dynamically if needed
3. Sends `{ action: 'openTranscriptModal' }` to content script
4. Content script delegates to `TranscriptOrchestrator.extractAndDisplay()`
5. Popup closes after modal opens on YouTube page

### settings.js (Settings Management)

**Default Prompt:**
`DEFAULT_PROMPT` constant provides a concise summary template for new users (Key Takeaways, Breakdown up to 5 topics, Notable Details with timestamps). Pre-filled when no `customPrompt` exists in storage.

**Per-Provider API Key Storage:**
`currentVisualProvider` tracks the UI's active provider. On provider switch, the outgoing key is auto-saved to `openaiApiKey`/`claudeApiKey` before loading the incoming provider's key. Save handler writes both `apiKey` (legacy) and the per-provider key.

**Model Caching Pattern:**
```javascript
let cachedModels = { openai: null, claude: null };

// Only fetch if not cached or force refresh
if (!forceRefresh && cachedModels[provider]) {
  populateModelSelect(cachedModels[provider]);
  return;
}
```

**Auto-fetch on API key blur:**
When user enters API key and moves to next field, automatically fetches available models.

**Claude Model List:**
Hardcoded in background.js only (settings.js delegates via message passing). Claude doesn't expose a public models endpoint.

Current models (as of v4.0.0):
- claude-opus-4-6 (Latest)
- claude-opus-4-5-20251101
- claude-sonnet-4-5-20250929
- claude-haiku-4-5-20251001
- claude-3-7-sonnet-20250219
- claude-3-5-sonnet-20241022/20240620
- claude-3-5-haiku-20241022
- claude-3-opus/sonnet/haiku-202402xx

### constants.js (Shared Constants)

Defines `YTE_CONSTANTS` object with:
- **Timing values:** `TOAST_DURATION`, `MUTATION_TIMEOUT`, `ERROR_RESET_DELAY`, etc.
- **Cache limits:** `MAX_CACHED_VIDEOS` (10), `MAX_CHAT_MESSAGES` (20)
- **API defaults:** `DEFAULT_MAX_TOKENS_OPENAI` (4000), `NANO_MAX_TOKENS` (2000), `CHAT_CONTEXT_CHAR_LIMIT` (4000)
- **Retry settings:** `MAX_RETRIES` (2), `RETRY_DELAYS`, `RETRYABLE_STATUS_CODES`
- **YouTube selectors:** `SELECTORS.MORE_ACTIONS[]`, `SELECTORS.TRANSCRIPT_SEGMENTS`, `SELECTORS.SEGMENT_TIMESTAMP[]`, `SELECTORS.SEGMENT_TEXT[]`, `SELECTORS.VIDEO_TITLE[]`, `SELECTORS.SIDEBAR[]`, `SELECTORS.MENU_ITEMS`, `SELECTORS.MENU_POPUP`

Loaded first in manifest (before `utils.js`). Object is frozen to prevent mutation.

### chat-manager.js (Chat Conversation State)

Manages per-video chat conversation state:
- `ChatManager.addMessage(videoId, role, content)` - Appends to in-memory history
- `ChatManager.getHistory(videoId)` - Returns message array
- `ChatManager.loadHistory(videoId, history)` - Loads from cache
- `ChatManager.getConversationPayload(videoId, contextText, provider)` - Builds API messages array with summary as system context
- `ChatManager.clearHistory(videoId)` - Resets conversation
- `ChatManager.hasHistory(videoId)` - Boolean check

**Token budget:** Uses summary (~500-1000 tokens) as context instead of full transcript. Falls back to first 4000 chars of transcript if no summary. 20-message limit per video.

**Provider differences:** OpenAI uses system message in messages array. Claude uses top-level `system` parameter.

### v3.0+ Components (Content Scripts)

#### utils.js (Shared Utilities)

Provides shared functions for all content scripts:
- `Utils.logError()` - Structured error logging with context and metadata
- `Utils.escapeHtml()` - Sanitizes HTML for safe display
- `Utils.markdownToHtml()` - Converts markdown to HTML for AI summaries
- `Utils.copyRichText(plainText, html)` - Copies to clipboard with dual format support (plain text + HTML)
- Used by modal-ui.js, transcript-orchestrator.js, and other content scripts

#### theme-detector.js (Theme Detection)

Detects YouTube's current theme (light/dark mode):
- Checks `html[dark]` attribute on document root
- Returns boolean `isDark` flag
- Used by modal-ui.js and content-injector.js for theme-aware styling

```javascript
const isDark = document.documentElement.hasAttribute('dark');
```

#### cache-manager.js (Local Cache with LRU Eviction)

Manages local cache for transcripts and AI summaries:
- Stores up to 10 most recent videos (LRU eviction)
- Uses Chrome `chrome.storage.local` (not synced across devices)
- Cache key: video ID
- Cache entry: `{ videoId, videoTitle, transcript, summary, chatHistory, timestamp }`
- Methods: `CacheManager.getCachedData()`, `CacheManager.setCachedData()`, `CacheManager.isCacheValid()`
- Automatic eviction of oldest entries when cache exceeds 10 items

**Storage format:**
```javascript
{
  'transcript_cache_videoId1': { videoId, videoTitle, transcript: {...}, summary: {...}, chatHistory: [], timestamp },
  'transcript_cache_videoId2': { ... },
  'transcript_cache_metadata': { videoIds: [...], lastCleanup: timestamp }
  // up to 10 entries
}
```

#### modal-ui.js (Modal UI System)

**v3.0.1 Architecture: Floating Corner Modal (No Overlay)**

Creates and manages a floating modal in the bottom-right corner:
- **No backdrop overlay** - allows video interaction while modal is open
- **Fixed positioning:** `bottom: 24px; right: 24px`
- **Compact size:** 450px width, 600px max height
- **Mobile responsive:** Full-screen on devices ≤768px

**Key methods:**
- `ModalUI.createModal(data, isDark)` - Creates floating modal directly in document.body
- `ModalUI.showLoading(isDark)` - Shows loading spinner while extracting
- `ModalUI.showError(message, isDark)` - Shows error state
- `ModalUI.close()` - Removes modal from DOM, shows FAB
- `ModalUI.minimize()` - Collapses to compact "Distill" branded pill, preserves state
- `ModalUI.expand()` - Restores from minimized state
- `ModalUI.updateStreamingContent(partialText, isFinal)` - Progressive streaming display
- `ModalUI._switchTab(tabName)` - Switches between Transcript/Summary tabs
- `ModalUI._buildChatHTML(data)` - Renders chat bubbles in Summary tab
- `ModalUI._appendChatMessage(role, content)` - Appends single bubble without full re-render
- `ModalUI._handleChatSend(data)` - Reads input, calls orchestrator, appends response
- `ModalUI._copyToClipboard(text, message, type)` - Copies content with rich text support

**v3.0.1 Features:**
1. **AI Summary Default Tab:** When `data.summary` exists, AI Summary tab is active by default
2. **Settings Gear Icon:** Header includes SVG gear button that opens settings.html in new tab
3. **Floating Corner Design:** Modal appears in bottom-right without backdrop, keeping video accessible

**Modal structure:**
```html
<div class="yte-modal yte-dark">  <!-- Appended directly to document.body -->
  <div class="yte-modal-header">
    <h2>Distill</h2>
    <div class="yte-modal-header-actions">
      <button class="yte-modal-settings"><svg><!-- gear icon --></svg></button>
      <button class="yte-modal-minimize">&minus;</button>  <!-- v4.0 -->
      <button class="yte-modal-close">×</button>
    </div>
  </div>
  <div class="yte-modal-tabs">
    <div class="yte-modal-tabs-container">  <!-- iOS segmented control -->
      <button class="yte-tab-btn">Transcript</button>
      <button class="yte-tab-btn yte-active">Summary</button>
    </div>
  </div>
  <div class="yte-modal-content">
    <div class="yte-tab-content">...</div>
    <div class="yte-tab-content yte-active">
      <div class="yte-summary-text">...</div>
      <div class="yte-chat-separator"></div>  <!-- v4.0 -->
      <div class="yte-chat-area">            <!-- v4.0 -->
        <button class="yte-chat-clear">Clear chat</button>
        <div class="yte-chat-messages">
          <div class="yte-chat-bubble yte-chat-bubble-user">...</div>
          <div class="yte-chat-bubble yte-chat-bubble-assistant">...</div>
        </div>
        <div class="yte-chat-input-row">
          <input class="yte-chat-input" placeholder="Ask about this video...">
          <button class="yte-chat-send"><svg><!-- send icon --></svg></button>
        </div>
      </div>
    </div>
  </div>
  <div class="yte-modal-footer">
    <button data-action="regenerate">Regenerate</button>
    <button data-action="copy-transcript">Copy Transcript</button>
    <button data-action="copy-summary">Copy Summary</button>
  </div>
</div>
```

**Close behavior:**
- Close button (×) - removes modal
- Escape key - removes modal
- No click-outside-to-close (no overlay to click)

#### modal-styles.css (Modal Styling)

Apple HIG flat design styles for the floating corner modal:
- CSS variables for light/dark themes (Apple HIG color palette)
- `.yte-modal` - Frosted glass floating corner (`backdrop-filter: blur(20px)`)
- `.yte-modal-header-actions` - Flex container for settings + minimize + close buttons
- `.yte-modal-settings` - SVG gear icon button (no emoji)
- `.yte-modal-minimize` - Minimize button matching header button style
- `.yte-modal.yte-minimized` - Frosted glass pill, same fixed bottom-right position
- `.yte-modal-tabs-container` - iOS segmented control (pill bg, active white/dark surface)
- `.yte-tab-btn` - Segmented control segments with active shadow
- `.yte-chat-*` - Chat UI: bubbles (user/assistant), input row, typing indicator
- `.yte-stream-cursor` - Blinking cursor during streaming
- `.yte-toast` - Pill-shaped, centered bottom, frosted glass background
- `.yte-btn` - Flat buttons with opacity hover (no box-shadow, no translateY)
- Responsive: full-screen on mobile (≤768px), minimize hidden
- Font: SF Pro system font stack (`-apple-system, BlinkMacSystemFont, ...`)

**Theme variables (Apple HIG):**
```css
.yte-modal.yte-light {
  --yte-bg: #F2F2F7;         /* systemGroupedBackground */
  --yte-text: #1C1C1E;       /* label */
  --yte-accent: #007AFF;     /* systemBlue */
  --yte-modal-bg: rgba(255, 255, 255, 0.85);  /* frosted glass */
  /* ... */
}

.yte-modal.yte-dark {
  --yte-bg: #1C1C1E;         /* systemBackground */
  --yte-text: #FFFFFF;        /* label */
  --yte-accent: #0A84FF;     /* systemBlue */
  --yte-modal-bg: rgba(28, 28, 30, 0.85);     /* frosted glass */
  /* ... */
}
```

#### transcript-orchestrator.js (Unified Extraction Flow)

Orchestrates the entire transcript extraction and display flow:

**Flow:**
1. Check if video is cached (`CacheManager.has(videoId)`)
2. If cached: Load from cache and display modal immediately
3. If not cached: Extract transcript via `content.js`
4. Save to cache with `CacheManager.set()`
5. Display modal with transcript (and AI summary if available)

**API:**
- `TranscriptOrchestrator.extractAndDisplay(videoId, source)` - Main entry point
- `TranscriptOrchestrator.regenerateSummary(videoId, transcript)` - Regenerate with streaming
- `TranscriptOrchestrator.sendChatMessage(videoId, userMessage)` - Send chat message
- `TranscriptOrchestrator._resolveApiKey(settings)` - Returns per-provider key, falls back to legacy `apiKey`
- `TranscriptOrchestrator._streamFromPort(portName, request)` - Stream AI response via background port
- `TranscriptOrchestrator._processWithAI(transcript, isDark)` - Streaming-first with non-streaming fallback

**Usage:**
Called by both popup.js (extension icon) and content-injector.js (FAB button)

#### content-injector.js (Floating FAB Entry Point)

Injects a distinctive floating purple pill FAB (Floating Action Button) on YouTube video pages:

**Features:**
- Desktop only (checks viewport width > 768px)
- Fixed position: `bottom: 90px; right: 24px;` (above modal area)
- Purple background (`#6C5CE7`), white text, pill shape (`border-radius: 100px`), shadow
- Inline SVG icon (white document with play triangle) before text label — avoids CSP issues with `chrome-extension://` image URLs
- Hover: `scale(1.05)` + enhanced shadow
- Hides when modal is open, reappears when modal closes
- `yt-navigate-finish` event listener for SPA navigation (no interval polling)
- Button text changes based on cache state:
  - "Distill" - First time (not cached)
  - "View" - Cached (instant load)
  - "Loading..." - During extraction
  - "Try Again" - After error

**Button placement:**
```javascript
document.body.appendChild(this.button); // Fixed position, not in sidebar
```

## Critical Code Patterns

### Chrome Storage (Sync)

Settings persist across Chrome browsers (encrypted by Chrome):

```javascript
// Save
chrome.storage.sync.set({
  apiProvider: 'openai',
  apiKey: 'sk-...',          // Derived: equals active provider's key (backward compat)
  openaiApiKey: 'sk-...',    // Per-provider key (persists across provider switches)
  claudeApiKey: 'sk-ant-...', // Per-provider key (persists across provider switches)
  customPrompt: '...',
  model: 'gpt-4o'
});

// Load
const settings = await chrome.storage.sync.get([
  'apiProvider', 'apiKey', 'openaiApiKey', 'claudeApiKey', 'customPrompt', 'model'
]);
// Use TranscriptOrchestrator._resolveApiKey(settings) to get the active provider's key
```

### YouTube DOM Resilience

Always use multiple fallback selectors:

```javascript
const button = document.querySelector('button[aria-label="More actions"]') ||
               document.querySelector('button[aria-label*="More"]') ||
               document.querySelector('ytd-menu-renderer button');
```

YouTube frequently updates their DOM structure. Multiple selectors increase resilience.

### DOM Waiting Strategy

v4.0 uses `MutationObserver` via `waitForElement(selector, timeout)` to detect DOM changes:
- Watches for menu popup after clicking "More actions"
- Watches for transcript segments after clicking "Show transcript"
- Falls back to fixed delays (800ms, 1500ms) if MutationObserver times out (3000ms safety net)
- Selectors are centralized in `YTE_CONSTANTS.SELECTORS`

## Version History

**v4.1.0** (2026-02-27) - Current
- **Per-Provider API Key Storage**: Both OpenAI and Claude API keys now persist independently
  - Switching providers no longer overwrites the previous key
  - New storage keys: `openaiApiKey`, `claudeApiKey` alongside legacy `apiKey` for backward compat
  - Auto-saves outgoing provider's key when switching in settings
  - Automatic one-time migration from legacy `apiKey` on settings load
  - Content scripts fall back to legacy `apiKey` via `_resolveApiKey()` before migration runs
- **Default Prompt for New Users**: Pre-fills a concise summary prompt template
  - Structured output: Key Takeaways, Breakdown (up to 5 major topics), Notable Details
  - Includes timestamps for navigation
  - Existing users keep their saved custom prompt

**v4.0.3** (2026-02-16)
- **FAB Inline SVG Icon**: Replaced `<img>` tag loading `icon16.png` with inline SVG to fix icon not rendering on YouTube
  - Root cause: YouTube's Content Security Policy blocks CSS filters on images loaded from `chrome-extension://` URLs in content scripts, making the icon invisible
  - Inline SVG bypasses CSP entirely — renders a white document icon with purple play triangle and transcript lines matching the extension's icon design
  - Removed the v4.0.2 CSS filter workaround (`brightness(0) invert(1)`) that was ineffective

**v4.0.2** (2026-02-16)
- **FAB Icon Fix (Superseded by v4.0.3)**: Applied `brightness(0) invert(1)` CSS filter to make the extension icon white on the purple FAB background (previously invisible purple-on-purple)
- **Compact Minimized Pill**: Replaced bulky minimized modal (truncated title + expand/close buttons) with compact "Distill" branded pill — entire title is clickable to expand, small close (x) button, keyboard accessible
- **Save Button Feedback**: Settings "Save Settings" button now shows "Saved" (green) or "Error" (red) text with color change for 2s after click
- **Status Message Visibility**: Fixed invisible status backgrounds on settings page — now uses semi-transparent tinted colors instead of blending into page background

**v4.0.1** (2026-02-16)
- **GPT-5-nano Fix**: Fixed summaries not displaying when using GPT-5-nano model
  - Root cause: GPT-5-nano is a reasoning model that consumed all 2000 `max_completion_tokens` on reasoning tokens, leaving `content: null` in the API response (`finish_reason: length`)
  - Increased GPT-5-nano token limit from 2000 → 16384 to provide headroom for reasoning + output
  - Added null/empty content validation in `callOpenAI` and `chatOpenAI` — now throws descriptive error instead of silently returning null
  - Streaming handler now checks `delta.reasoning_content` as fallback for reasoning model responses
  - `_processWithAI` now handles undefined `chrome.runtime.sendMessage` responses and logs fallback path
  - `ModalUI.showLoading()` now closes existing modal first to prevent duplicate modal elements
- **Constants:** `NANO_MAX_TOKENS` updated from 2000 → 16384

**v4.0.0** (2026-02-15)
- **Conversational AI Chat**: Chat with AI about video content after summary is generated
  - iMessage-style chat bubbles (user right/accent, assistant left/surface) in Summary tab
  - Uses summary as system context to manage token budget
  - 20-message limit per video, history persisted in cache
  - Typing indicator with pulsing dots, auto-scroll, clear chat button
  - Chat cleared when summary is regenerated (stale context)
  - Provider-specific payloads (OpenAI system message vs Claude top-level system param)
- **Streaming API Responses**: Real-time text streaming for AI summaries
  - Port-based messaging (`chrome.runtime.connect()`) for streaming
  - SSE parsing for both OpenAI and Claude streaming endpoints
  - Progressive text display with blinking cursor, full markdown on completion
  - `requestAnimationFrame` throttled DOM updates (~60fps)
  - Fallback to non-streaming if streaming fails
- **MutationObserver DOM Extraction**: Faster transcript extraction
  - `waitForElement(selector, timeout)` replaces fixed `setTimeout` delays
  - 1-2 second savings per uncached extraction
  - 3000ms timeout safety net with fixed-delay fallback
- **GPT-5-nano Defensive Improvements**:
  - Model-specific token limits (GPT-5-nano: 16384 for reasoning headroom, others: 4000)
  - `fetchWithRetry()` with exponential backoff for transient errors (429, 500, 502, 503)
  - Max 2 retries, delays: 1s, 2s — applies to all models
  - Enhanced error logging with model and status details
- **Claude Opus 4.6**: Added `claude-opus-4-6` as Latest model, Opus 4.5 demoted
- **Minimize Modal**: Collapse modal to frosted glass pill in bottom-right corner
  - Preserves state (active tab, scroll position, chat messages)
  - Expand button restores full modal with saved state
  - Hidden on mobile (no minimize button on screens ≤768px)
  - Navigation closes minimized pill
- **Floating FAB Entry Point**: Distinctive purple floating pill button
  - Fixed position (`bottom: 90px; right: 24px;`), `#6C5CE7` purple, pill shape
  - Extension icon (`icon16.png`) + text label
  - Hover: `scale(1.05)` + enhanced shadow
  - Hides when modal open, reappears on close
  - Removed sidebar integration and `setInterval` URL polling
- **Code Refactoring**:
  - New `constants.js` with centralized `YTE_CONSTANTS` (timing, selectors, limits)
  - New `chat-manager.js` for per-video conversation state
  - Deleted dead `api.js` (never called since v3.0)
  - Removed unused `originalTranscript`/`copyTranscriptBtn` from popup.js
  - Removed unused CSS rules from popup.css
  - Shared header builders and request body builder in background.js
  - YouTube selectors centralized in constants, used across content.js and utils.js

**v3.1.0** (2026-01-30)
- **Apple/iOS Native UI Redesign**: Full visual overhaul to Apple HIG flat aesthetic
  - SF Pro system font stack (`-apple-system, BlinkMacSystemFont, ...`) throughout all surfaces
  - Apple HIG color palette: `#007AFF`/`#0A84FF` system blue, `#F2F2F7`/`#1C1C1E` backgrounds
  - Frosted glass modal with `backdrop-filter: blur(20px)` and semi-transparent background
  - iOS segmented control tabs replacing underline-style tabs
  - Flat buttons with opacity hover (removed all `box-shadow`, `translateY`, `filter: brightness` effects)
  - Pill-shaped centered toast notifications with frosted glass background
  - Removed all emoji from UI controls (clean text labels only)
  - SVG gear icon replacing emoji settings button in modal
  - Settings: uppercase letterspaced section headers, filled inputs (no border), text Show/Hide toggle
  - Settings: refresh button uses "Refresh" text instead of emoji
  - In-page button: clean labels ("Distill", "View", "Loading...", "Try Again")
  - Thinner scrollbars (6px) with subtle colors
  - Subtle error state (background tint only, no left border bar, no emoji)
  - All `::before` content emoji pseudo-elements removed from status/toast/error/info messages
  - Uses `:focus-visible` instead of `:focus` for keyboard-only focus rings
  - 10px border radius on buttons and inputs (Apple standard)

**v3.0.6** (2026-01-20)
- **Regenerate AI Summary Feature**: Added ability to regenerate or generate AI summaries from modal
  - New "Regenerate" / "Generate Summary" button in modal footer
  - Button state adapts based on AI configuration and existing summary
  - Loading animation with pulse effect during regeneration
  - Toast notifications for success/failure feedback
  - Double-click prevention during processing
  - Cache automatically updated with regenerated summaries
  - Settings validation before regeneration attempt

**v3.0.5** (2026-01-19)
- **Extension Context Invalidation Fix**: Improved error handling when extension is reloaded
  - Added `Utils.isChromeAPIAvailable()` to check Chrome API availability
  - Enhanced error detection to catch "Cannot read properties of undefined" errors
  - Shows clear user-facing error modal: "Extension was reloaded. Please refresh (F5)"
  - Prevents cryptic console errors and silent failures
  - Added guard checks in TranscriptOrchestrator before accessing chrome.storage

**v3.0.4** (2026-01-19)
- Complete UI/UX modernization: unified design system, dark/light theme support, CSS variables
- Rich text copy support (dual MIME: text/plain + text/html for formatted paste in Docs/Word)
- Arc Browser compatibility fix (chrome.tabs.create instead of window.open)
- OpenAI API compatibility fix (max_completion_tokens for newer models, temperature exclusion for O1)
- Improved OpenAI model filtering and user-friendly labels
- Accessibility: focus outlines, ARIA labels, keyboard navigation

**v3.0.3** (2026-01-19)
- UI engagement improvements: button styling and text updates (superseded by v3.1.0)

**v3.0.2** (2026-01-19)
- Fixed stale modal data on video navigation
- Modal automatically closes when navigating to new videos
- Added currentVideoId tracking to prevent showing wrong video's data
- Button click handler uses current URL instead of stale captured videoId
- Fixed markdown bold/italic rendering in AI summaries (list items and headers)
- Enhanced markdownToHtml() with applyInlineFormatting() helper function

**v3.0.1** (2026-01-18)
- AI Summary tab as default when summary exists
- Settings gear icon in modal header
- Floating corner modal (no backdrop overlay)
- Video remains accessible while modal open

**v3.0.0** (2026-01-18) - Major Release
- In-page "Get Transcript" button (desktop sidebar)
- Smart caching system (10 most recent videos, LRU eviction)
- Modern modal UI with tabs (Transcript/AI Summary)
- Dual entry points (in-page button + extension icon)
- Theme detection (auto light/dark mode)
- Content script architecture with modular components
- Instant loading for cached transcripts

**v2.2.0** (2026-01-18)
- API key fixes
- Updated model lists

**v2.0.0** (2026-01-09) - Major Release
- Settings panel with gear icon
- OpenAI and Claude API integration
- Custom prompt functionality
- Dynamic model fetching
- Model caching

**v1.1-timestamp**
- Added timestamp extraction
- Enhanced error handling

**v1.0.0** - Initial Release
- Basic transcript extraction
- One-click copy to clipboard

## Versioning

Semantic versioning (MAJOR.MINOR.PATCH):
- **MAJOR** (x.0.0): Breaking changes
- **MINOR** (x.y.0): New features
- **PATCH** (x.y.z): Bug fixes

Increment by 0.0.1 for patches, 0.1.0 for features.

## Testing Checklist

Manual testing required (no automated tests):

### Core Functionality
- [ ] Extension loads without errors
- [ ] Transcript extraction works (try TED Talks, music videos)
- [ ] Timestamps formatted correctly `[0:00] text`
- [ ] Error messages for videos without transcripts

### Entry Points (v4.0)
- [ ] Purple floating FAB pill appears in bottom-right (desktop only)
- [ ] FAB has inline SVG icon + text label
- [ ] FAB text: "Distill" (first time), "View" (cached)
- [ ] FAB hover: scale up + enhanced shadow
- [ ] FAB hides when modal opens, reappears when modal closes
- [ ] Extension icon popup opens on YouTube video pages
- [ ] Both entry points open the same modal on YouTube page

### Modal UI (v3.0.1)
- [ ] Modal appears in bottom-right corner (not centered)
- [ ] No dark backdrop overlay present
- [ ] Video player remains clickable and playable with modal open
- [ ] AI Summary tab is active by default (when summary exists)
- [ ] Transcript tab is active by default (when no summary)
- [ ] Settings gear icon (SVG) appears in modal header
- [ ] Clicking settings gear opens settings.html in new tab
- [ ] Close button (×) closes modal
- [ ] Escape key closes modal
- [ ] Tab switching works between Transcript/Summary
- [ ] Copy buttons work for both tabs
- [ ] Toast notifications appear on copy
- [ ] Rich text copy: Paste summary in Google Docs shows formatted text (bold, lists, etc.)
- [ ] Rich text copy: Paste summary in VS Code shows plain markdown
- [ ] Rich text copy: Transcript copies as plain text with timestamps
- [ ] iOS segmented control tabs switch correctly
- [ ] Frosted glass modal background with blur effect
- [ ] Toast notifications are pill-shaped and centered
- [ ] No emoji visible in any UI controls
- [ ] Mobile: modal is full-screen (≤768px)

### Chat (v4.0)
- [ ] Chat input appears below summary in Summary tab
- [ ] Chat input disabled with message when no summary exists
- [ ] Send message via Enter key
- [ ] Send message via circular send button
- [ ] User messages appear right-aligned with accent color
- [ ] Assistant messages appear left-aligned with surface color
- [ ] Typing indicator (pulsing dots) while waiting for response
- [ ] Chat works with OpenAI models
- [ ] Chat works with Claude models
- [ ] Chat history persists across minimize/expand
- [ ] Chat history clears when summary is regenerated
- [ ] "Clear chat" button appears when messages exist
- [ ] Chat scrolls to newest message
- [ ] Max 20 messages enforced

### Streaming (v4.0)
- [ ] Summary text appears progressively during streaming
- [ ] Blinking cursor visible during stream
- [ ] Full markdown rendered on stream completion
- [ ] Streaming works with OpenAI
- [ ] Streaming works with Claude
- [ ] Fallback to non-streaming if streaming fails
- [ ] Closing modal during stream doesn't cause errors

### Minimize (v4.0)
- [ ] Minimize button (&minus;) appears in modal header
- [ ] Clicking minimize collapses to frosted glass pill
- [ ] Pill shows "Distill" brand label
- [ ] Clicking pill title expands full modal
- [ ] Active tab preserved after expand
- [ ] Scroll position preserved after expand
- [ ] Chat history preserved after expand
- [ ] Navigation closes minimized pill
- [ ] No minimize button on mobile (≤768px)

### GPT-5-nano (v4.0)
- [ ] GPT-5-nano uses 2000 token limit
- [ ] Transient errors (429, 500, 502, 503) trigger retry
- [ ] Max 2 retries with 1s, 2s delays
- [ ] Detailed error messages displayed in toast

### Caching System (v3.0)
- [ ] First extraction caches transcript
- [ ] Revisiting cached video loads instantly
- [ ] Cache includes AI summary if processed
- [ ] Cache persists across browser sessions
- [ ] 11th video evicts oldest cached video
- [ ] Cache works independently per video ID

### Settings & API Processing
- [ ] Settings button opens settings page
- [ ] Settings persist after saving
- [ ] API keys load correctly when reopening settings
- [ ] Models fetch automatically when API key entered
- [ ] AI processing works with valid API keys
- [ ] AI summary appears in separate tab in modal
- [ ] Fallback to original transcript on API errors
- [ ] Clear settings removes all stored data

## Known Limitations

1. **YouTube UI Dependency:** Relies on specific DOM selectors that may break when YouTube updates (centralized in `constants.js`)
2. **MutationObserver + Fallback Delays:** MutationObserver with 3s timeout, falls back to fixed delays if observer fails
3. **Only `/watch?v=` URLs:** Doesn't work on playlists, channels, homepage
4. **FAB desktop only:** Floating button only appears on desktop (viewport > 768px)
5. **Cache size limit:** Only 10 most recent videos cached (LRU eviction)
6. **Cache not synced:** Cache uses `chrome.storage.local` and doesn't sync across devices
7. **Claude Model List Hardcoded:** No public API endpoint, must update manually when new models release
8. **Token Limits:** OpenAI max_tokens=4000 (GPT-5-nano: 16384 for reasoning headroom), Claude max_tokens=4096
9. **Modal z-index conflicts:** Modal uses z-index 999999, FAB uses 999998
10. **Chat context limited:** Chat uses summary (not full transcript) as context to manage tokens. Max 20 messages per video.
11. **Streaming partial markdown:** During streaming, raw text is shown (not rendered markdown). Full markdown rendered on completion.
12. **MV3 service worker timeout:** Active fetch keeps service worker alive, but streaming may disconnect on very long responses (30s idle timeout)

## Security Notes

**Permissions:**
- `activeTab` - Access current tab only
- `scripting` - Inject content.js dynamically
- `clipboardWrite` - Copy transcripts
- `storage` - Chrome sync storage (encrypted)
- Host permissions: youtube.com, api.openai.com, api.anthropic.com

**API Keys:**
- Stored in Chrome's encrypted sync storage
- Never transmitted except to the selected API provider
- User responsible for key security and rotation

**No external services:** Extension doesn't send data to any third parties. API calls go directly to OpenAI/Claude.

## Git Workflow

**Branches:**
- `main` - Stable branch (contains v4.0.0). Default branch on GitHub.
- `v2.0`, `v3.0` - Version branches (merged into main)
- `v2.0-feature-expansion`, `v3-enhancements` - Feature branches (archived)
- `v1.1-timestamp` - Old stable branch name (replaced by main, can be deleted)

**Workflow:**
1. Create feature branches from `main`
2. Name feature branches descriptively (e.g., `v3.1-feature-name` or `bugfix-description`)
3. All pull requests should target `main` branch
4. After merging, version branches can be kept for reference

### Pre-Commit Documentation Checklist

**Before every commit and push**, ensure the following documentation is up to date with the changes being committed:

**CLAUDE.md updates (required if any of these changed):**
- [ ] Version number in "Project Overview" and "Last Updated" footer
- [ ] Version History section with new entry describing the changes
- [ ] Architecture Overview if files were added, removed, or renamed
- [ ] Component descriptions if behavior or API of a component changed
- [ ] Key Components section if new functions, parameters, or message types were added
- [ ] Critical Code Patterns if new patterns were introduced
- [ ] Testing Checklist if new testable behavior was added
- [ ] Known Limitations if new limitations were introduced or existing ones resolved

**README.md updates (required if any of these changed):**
- [ ] Version number and feature descriptions
- [ ] Installation or usage instructions if the user-facing workflow changed
- [ ] Screenshots or feature list if visible UI changed
- [ ] Any user-facing information that no longer matches the code

**Rule:** Do not commit code changes without also committing the corresponding documentation updates in the same commit. If only documentation changed, that's fine as a standalone commit.

---

**Last Updated:** 2026-02-27
**Current Version:** 4.1.0
